// Auto-save functionality
        setInterval(() => {
            updateProjectData();
            localStorage.setItem('riskManagementProject', JSON.stringify({
                ...projectData,
                risks: risks,
                timestamp: new Date().toISOString()
            }));
        }, 30000); // Auto-save every 30 seconds

        // 🚀 DOCUMENT ANALYSIS FUNCTIONALITY - PROFESSIONAL AI INTEGRATION
        async function handleDocumentUpload(event) {
            console.log('🔍 Starting professional document analysis');
            const file = event.target.files[0];
            
            if (!file) {
                alert('❌ לא נבחר קובץ');
                return;
            }

            const statusDiv = document.getElementById('analysis-status');
            const progressDiv = document.getElementById('analysis-progress');
            
            if (!statusDiv || !progressDiv) {
                alert('❌ שגיאה במערכת - לא נמצאו אלמנטי ממשק');
                return;
            }
            
            statusDiv.style.display = 'block';
            progressDiv.innerHTML = '🚀 מתחיל ניתוח מקצועי של המסמך...';

            try {
                let documentText = '';
                
                // 📄 STEP 1: EXTRACT TEXT FROM DOCUMENT
                if (file.type === 'text/plain') {
                    progressDiv.innerHTML = '📝 קורא קובץ טקסט...';
                    documentText = await file.text();
                } else if (file.type.includes('pdf')) {
                    progressDiv.innerHTML = '📄 מעבד קובץ PDF בטכנולוגיה מתקדמת...';
                    documentText = await extractTextFromFile(file);
                } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    progressDiv.innerHTML = '📝 מעבד מסמך Word עם טכנולוגיה מתקדמת...';
                    documentText = await extractTextFromFile(file);
                } else {
                    throw new Error('סוג קובץ לא נתמך. אנא העלה קובץ PDF, Word או טקסט');
                }

                if (!documentText || documentText.length < 50) {
                    throw new Error('המסמך ריק או קצר מדי. אנא העלה מסמך עם תוכן רלוונטי');
                }

                // 🤖 STEP 2: ANALYZE WITH AI
                progressDiv.innerHTML = '🧠 מנתח עם בינה מלאכותית מתקדמת - זיהוי פרויקט וסיכונים...';
                
                if (!window.claude || !window.claude.complete) {
                    throw new Error('בינה מלאכותית לא זמינה. וודא שאתה משתמש ב-Claude.ai');
                }
                
                const analysis = await analyzeDocumentWithAI(documentText, file.name);
                
                // 🎯 STEP 3: UPDATE ALL FORMS
                progressDiv.innerHTML = '✨ עדכון כל השדות והשלבים...';
                await updateAllFormsFromAnalysis(analysis);
                
                // 🎉 SUCCESS
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                    showSuccessMessage('🎉 הניתוח הושלם בהצלחה! כל השדות עודכנו אוטומטית!');
                }, 2000);

            } catch (error) {
                console.error('❌ Document analysis error:', error);
                progressDiv.innerHTML = `❌ שגיאה בניתוח: ${error.message}`;
                
                if (error.message.includes('Claude')) {
                    progressDiv.innerHTML += '<br><small>💡 וודא שאתה משתמש ב-Claude.ai ולא בדפדפן רגיל</small>';
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 6000);
            }
        }

        async function extractTextFromFile(file) {
            if (file.type === 'text/plain') {
                return await file.text();
            }
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let text = e.target.result;
                        // Clean and normalize text
                        text = text.replace(/[^\x20-\x7E\u0590-\u05FF\s\n\r]/g, ' ');
                        text = text.replace(/\s+/g, ' ');
                        text = text.trim();
                        resolve(text);
                    } catch (error) {
                        reject(new Error('שגיאה בעיבוד הקובץ'));
                    }
                };
                reader.onerror = () => reject(new Error('שגיאה בקריאת הקובץ'));
                reader.readAsText(file, 'utf-8');
            });
        }

        async function analyzeDocumentWithAI(documentText, fileName) {
            const prompt = `אתה מומחה לניהול פרויקטים וסיכונים. נתח את המסמך הבא בצורה מקצועית וחלץ ממנו מידע מפורט:

שם הקובץ: ${fileName}
תוכן המסמך:
${documentText}

אנא חזור עם JSON במבנה הבא בלבד (ללא טקסט נוסף):
{
  "projectInfo": {
    "name": "שם הפרויקט המופיע במסמך",
    "manager": "שם מנהל הפרויקט אם מופיע", 
    "organization": "שם הארגון/בית ספר/מוסד",
    "type": "educational|technological|infrastructure|organizational|research|community",
    "scope": "local|school|district|national",
    "description": "תיאור מפורט של הפרויקט כפי שמופיע במסמך",
    "startDate": "YYYY-MM-DD או null אם לא צוין",
    "endDate": "YYYY-MM-DD או null אם לא צוין", 
    "stakeholders": "רשימת בעלי העניין והגורמים המעורבים"
  },
  "risks": [
    {
      "description": "תיאור מפורט של הסיכון",
      "category": "קטגוריית הסיכון",
      "probability": 7,
      "impact": 8
    }
  ],
  "innovation": {
    "level": "low|medium|high",
    "description": "תיאור האספקטים החדשניים בפרויקט",
    "complianceLevel": "low|medium|high"
  },
  "recommendations": "המלצות מפורטות לניהול הפרויקט",
  "nextSteps": "צעדים הבאים מומלצים"
}

חשוב מאוד: 
- זהה לפחות 3-5 סיכונים רלוונטיים לפרויקט
- דרג probability ו-impact בין 1-10
- החזר רק JSON תקין ללא טקסט נוסף!`;

            try {
                const response = await window.claude.complete(prompt);
                
                // Extract JSON from response
                let jsonText = response.trim();
                const jsonStart = jsonText.indexOf('{');
                const jsonEnd = jsonText.lastIndexOf('}');
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    jsonText = jsonText.substring(jsonStart, jsonEnd + 1);
                }
                
                const analysis = JSON.parse(jsonText);
                
                // Validate analysis
                if (!analysis.projectInfo) {
                    throw new Error('הניתוח לא הצליח לחלץ מידע על הפרויקט');
                }
                
                return analysis;
            } catch (error) {
                console.error('AI analysis error:', error);
                throw new Error('שגיאה בניתוח המסמך עם בינה מלאכותית. נסה עם מסמך אחר');
            }
        }

        async function updateAllFormsFromAnalysis(analysis) {
            // 🎯 UPDATE PROJECT INFO
            if (analysis.projectInfo) {
                const info = analysis.projectInfo;
                
                if (info.name) {
                    document.getElementById('project-name').value = info.name;
                    projectData.name = info.name;
                }
                if (info.manager) {
                    document.getElementById('project-manager').value = info.manager;
                    projectData.manager = info.manager;
                }
                if (info.organization) {
                    document.getElementById('organization').value = info.organization;
                    projectData.organization = info.organization;
                }
                if (info.scope) {
                    document.getElementById('project-scope').value = info.scope;
                    projectData.scope = info.scope;
                }
                if (info.description) {
                    document.getElementById('project-description').value = info.description;
                    projectData.description = info.description;
                }
                if (info.startDate && info.startDate !== 'null') {
                    document.getElementById('start-date').value = info.startDate;
                    projectData.startDate = info.startDate;
                }
                if (info.endDate && info.endDate !== 'null') {
                    document.getElementById('end-date').value = info.endDate;
                    projectData.endDate = info.endDate;
                }
                if (info.stakeholders) {
                    document.getElementById('stakeholders').value = info.stakeholders;
                    projectData.stakeholders = info.stakeholders;
                }
                
                // Select project type
                if (info.type) {
                    const typeElements = document.querySelectorAll('.project-type');
                    typeElements.forEach(el => {
                        if (el.onclick && el.onclick.toString().includes(info.type)) {
                            selectProjectType(el, info.type);
                        }
                    });
                }
            }

            // 🚨 UPDATE RISKS
            if (analysis.risks && analysis.risks.length > 0) {
                // Clear existing risks
                risks = [];
                document.getElementById('risks-table').innerHTML = '';
                
                // Add analyzed risks
                for (const riskData of analysis.risks) {
                    addProfessionalRisk(riskData);
                }
                
                updateRiskCounts();
                generateRiskMatrix();
            }

            // 💡 UPDATE INNOVATION
            if (analysis.innovation) {
                const innovation = analysis.innovation;
                
                if (innovation.level) {
                    const levelElements = document.querySelectorAll('.innovation-level');
                    levelElements.forEach(el => {
                        if (el.onclick && el.onclick.toString().includes(innovation.level)) {
                            selectInnovationLevel(el, innovation.level);
                        }
                    });
                }
                
                if (innovation.description) {
                    const innovationDesc = document.getElementById('innovation-description');
                    if (innovationDesc) {
                        innovationDesc.value = innovation.description;
                        projectData.innovationDescription = innovation.description;
                    }
                }
                
                if (innovation.complianceLevel) {
                    const complianceEl = document.getElementById('overall-compliance');
                    if (complianceEl) {
                        complianceEl.value = innovation.complianceLevel;
                        projectData.complianceLevel = innovation.complianceLevel;
                    }
                }
            }

            // 📋 STORE RECOMMENDATIONS AND NEXT STEPS
            projectData.mainRecommendations = analysis.recommendations || '';
            projectData.nextSteps = analysis.nextSteps || '';
            
            // 🔄 UPDATE UI COMPONENTS
            updateInnovationDisplay();
            setTimeout(() => {
                updateResponseStrategies();
            }, 500);
        }

        function addProfessionalRisk(riskData) {
            const riskCategories = {
                'educational': ['פדגוגי', 'טכנולוגי', 'משאבים', 'לוח זמנים', 'צוות'],
                'technological': ['טכני', 'אבטחה', 'תאימות', 'ביצועים', 'תמיכה'],
                'infrastructure': ['תקציב', 'בטיחות', 'רגולציה', 'לוח זמנים', 'איכות'],
                'organizational': ['שינוי', 'התנגדות', 'תקשורת', 'הכשרה', 'מדיניות'],
                'research': ['מתודולוגיה', 'נתונים', 'אתיקה', 'תקציב', 'פרסום'],
                'community': ['מעורבות', 'תקשורת', 'משאבים', 'תמיכה', 'יישום']
            };

            const categories = riskCategories[currentProjectType] || ['כללי', 'טכני', 'תפעולי', 'משאבים', 'לוח זמנים'];
            
            const riskId = `risk-${riskIdCounter++}`;
            const probability = Math.min(10, Math.max(1, parseInt(riskData.probability) || 5));
            const impact = Math.min(10, Math.max(1, parseInt(riskData.impact) || 5));
            
            const risk = {
                id: riskId,
                description: riskData.description || '',
                category: riskData.category || categories[0],
                probability: probability,
                impact: impact,
                severity: probability * impact
            };
            
            risks.push(risk);
            
            const tableBody = document.getElementById('risks-table');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="risk-input" value="${risk.description}" onchange="updateRisk('${riskId}', 'description', this.value)"></td>
                <td>
                    <select class="risk-input" onchange="updateRisk('${riskId}', 'category', this.value)">
                        ${categories.map(cat => `<option value="${cat}" ${cat === risk.category ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" min="1" max="10" class="risk-input" value="${risk.probability}" onchange="updateRisk('${riskId}', 'probability', this.value)"></td>
                <td><input type="number" min="1" max="10" class="risk-input" value="${risk.impact}" onchange="updateRisk('${riskId}', 'impact', this.value)"></td>
                <td><span class="risk-level ${getRiskLevelClass(risk.severity)}" id="severity-${riskId}">${risk.severity}</span></td>
                <td><button class="btn btn-gradient-fire btn-sm" onclick="removeRisk('${riskId}')">🗑️ מחק</button></td>
            `;
            
            tableBody.appendChild(row);
        }

        function showAnalysisExample() {
            const exampleWindow = window.open('', '_blank', 'width=1000,height=800,scrollbars=yes');
            exampleWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>🚀 דוגמה מקצועית לניתוח מסמך עם בינה מלאכותית</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Segoe UI', Arial, sans-serif; 
                            margin: 0; 
                            line-height: 1.6; 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: #333;
                            min-height: 100vh;
                        }
                        .container {
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            max-width: 900px;
                            margin: 30px auto;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 40px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 30px;
                            border-radius: 15px;
                            margin: -40px -40px 40px -40px;
                        }
                        h1 { 
                            font-size: 32px;
                            margin: 0;
                            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        }
                        .subtitle {
                            font-size: 18px;
                            margin-top: 10px;
                            opacity: 0.9;
                        }
                        .example { 
                            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                            padding: 25px; 
                            border-left: 5px solid #667eea; 
                            margin: 25px 0; 
                            border-radius: 10px;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        }
                        h2, h3 { 
                            color: #2c3e50; 
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 10px;
                        }
                        .feature {
                            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
                            color: white;
                            padding: 20px;
                            margin: 15px 0;
                            border-radius: 10px;
                            font-weight: bold;
                            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
                            transition: transform 0.3s ease;
                        }
                        .feature:hover {
                            transform: translateY(-3px);
                        }
                        .tip {
                            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                            color: white;
                            padding: 15px;
                            margin: 10px 0;
                            border-radius: 8px;
                            box-shadow: 0 3px 10px rgba(17, 153, 142, 0.3);
                        }
                        .step {
                            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
                            color: #2d3436;
                            padding: 20px;
                            margin: 15px 0;
                            border-radius: 10px;
                            border-left: 5px solid #fdcb6e;
                            font-weight: 600;
                        }
                        button {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; 
                            padding: 20px 40px; 
                            border: none; 
                            border-radius: 15px; 
                            cursor: pointer; 
                            font-size: 18px;
                            font-weight: bold;
                            display: block;
                            margin: 40px auto 20px auto;
                            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
                            transition: all 0.3s ease;
                        }
                        button:hover {
                            transform: translateY(-3px);
                            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
                        }
                        .stats {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin: 30px 0;
                        }
                        .stat {
                            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 10px;
                            text-align: center;
                            box-shadow: 0 5px 15px rgba(253, 121, 168, 0.3);
                        }
                        .stat-number {
                            font-size: 32px;
                            font-weight: bold;
                            display: block;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>🚀 ניתוח מסמך פרויקט מקצועי</h1>
                            <div class="subtitle">טכנולוגיה מתקדמת עם בינה מלאכותית</div>
                        </div>
                        
                        <h2>💫 יכולות המערכת המתקדמות</h2>
                        <div class="feature">📄 ניתוח חכם של קבצי PDF מורכבים עם זיהוי מבנה</div>
                        <div class="feature">📝 עיבוד מתקדם של מסמכי Word (.docx, .doc) עם שמירת פורמט</div>
                        <div class="feature">📄 קריאה מיטבית של קבצי טקסט רגיל (.txt)</div>
                        <div class="feature">🎯 זיהוי אוטומטי ומדויק של סיכונים ואזדמנויות</div>
                        <div class="feature">📊 הערכה חכמה של חומרת סיכונים עם ניתוח הסתברותי</div>
                        <div class="feature">🔍 חילוץ מידע מקצועי על בעלי עניין ולוחות זמנים</div>
                        <div class="feature">💡 הערכה אוטומטית של רמת חדשנות ואסדרה</div>
                        
                        <h2>🚀 תהליך הניתוח המקצועי</h2>
                        <div class="step">1️⃣ <strong>העלאה ואימות</strong> - המערכת בודקת את סוג הקובץ ואת תקינותו</div>
                        <div class="step">2️⃣ <strong>חילוץ טקסט מתקדם</strong> - טכנולוגיה מתקדמת לחילוץ מדויק</div>
                        <div class="step">3️⃣ <strong>ניתוח עם בינה מלאכותית</strong> - Claude מנתח את התוכן בצורה מקצועית</div>
                        <div class="step">4️⃣ <strong>זיהוי סיכונים</strong> - המערכת מזהה סיכונים ומדרגת אותם</div>
                        <div class="step">5️⃣ <strong>מילוי אוטומטי</strong> - כל השדות במערכת מתמלאים אוטומטית</div>
                        <div class="step">6️⃣ <strong>יצירת המלצות</strong> - המערכת יוצרת המלצות מותאמות אישית</div>
                        
                        <div class="example">
                            <h3>🎯 דוגמה למסמך פרויקט מושלם</h3>
                            <p><strong>🏷️ שם הפרויקט:</strong> מערכת ניהול למידה דיגיטלית לחטיבת ביניים</p>
                            <p><strong>👤 מנהל הפרויקט:</strong> ד"ר מרים כהן, רכזת חדשנות פדגוגית</p>
                            <p><strong>🏫 ארגון:</strong> בית ספר יסודי "נווה שלום" - מגזר ציבורי</p>
                            <p><strong>📝 תיאור מפורט:</strong> פיתוח פלטפורמה דיגיטלית מתקדמת לשיפור חוויית הלמידה עבור 450 תלמידי בית הספר. הפרויקט כולל פיתוח כלי אינטראקטיביים, מערכת מעקב התקדמות אישית, פורטל הורים מתקדם וכלי בינה מלאכותית לליווי למידה.</p>
                            <p><strong>🎯 יעדים מדידים:</strong> שיפור הישגי התלמידים ב-25% במתמטיקה ומדעים, העלאת מעורבות הורים ב-40%, הפחתת זמן ההכנה למורים ב-30%</p>
                            <p><strong>⚠️ סיכונים מזוהים:</strong> עיכובים טכנולוגיים (احتمال: 7, השפעה: 8), התנגדות מצד מורים ותיקים (احتمال: 6, השפעה: 7), אתגרי תקציב (احتمال: 5, השפעה: 9), בעיות אבטחת מידע (احتمال: 4, השפעה: 10)</p>
                            <p><strong>📅 לוח זמנים:</strong> תחילה: 01/09/2024, סיום: 30/06/2025</p>
                            <p><strong>👥 בעלי עניין:</strong> הנהלת בית הספר, צוות המורים, הורים, תלמידים, מחלקת IT, משרד החינוך</p>
                        </div>
                        
                        <div class="stats">
                            <div class                <div class="summary-box">
                    <h3>ניתוח מסמך פרויקט</h3>
                    <p>העלה מסמך פרויקט קיים (Word, PDF, טקסט) והמערכת תנתח אותו אוטומטית ותמלא את כל השלבים</p>
                    <input type="file" id="document-upload" accept=".pdf,.doc,.docx,.txt" style="display: none;" onchange="handleDocumentUpload(event)">
                    <div class="action-buttons" style="margin: 15px 0;">
                        <button class="btn btn-gradient-sunset btn-glow btn-lg" onclick="document.getElementById('document-upload').click()">
                            📄 העלה מסמך לניתוח
                        </button>
                        <button class="btn btn-gradient-forest btn-sm" onclick="showAnalysisExample()">
                            💡 הצג דוגמה
                        </button>
                    </div>
                    <div id="analysis-status" style="display: none; margin: 15px 0; padding: 15px; border-radius: 8px; background: #d5e8f7; border-left: 4px solid #3498db;">
                        <div id="analysis-progress">🔍 מנתח מסמך...</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-gradient-ocean btn-animated btn-lg" onclick="showSection('risk-management')">
                        ➡️ המשך לניהול סיכונים
                    </button>
                </div>
